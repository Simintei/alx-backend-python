#!/bin/bash
# Rolling update script for Django app with zero downtime

set -e

echo "🚀 Starting rolling update for Django app..."

# Apply updated deployment (new image version)
kubectl apply -f blue_deployment.yaml

# Monitor rollout status
echo "⏳ Monitoring rollout status..."
kubectl rollout status deployment/django-blue

# Continuous curl test to check for downtime
echo "🌐 Testing app availability during rollout..."
SERVICE_IP=$(minikube service django-service --url | head -n 1)

echo "Sending 20 requests to check for disruption..."
for i in {1..20}; do
  curl -s -o /dev/null -w "%{http_code} " $SERVICE_IP || echo "❌ Request failed"
  sleep 1
done

echo
echo "✅ Rollout completed successfully."

# Verify pods after rollout
echo "🔍 Verifying running pods..."
kubectl get pods -l app=django
